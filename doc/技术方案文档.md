# eFront 私募基金管理系统 - 技术方案文档

## 1. 文档概述

### 1.1 文档目的
本文档详细阐述 eFront 私募基金管理系统的技术架构、技术选型、模块设计、数据库设计、API 设计和部署方案，为系统开发提供技术指导。

### 1.2 技术栈概览
- **前端**: React 18 + TypeScript + TailAdmin (Tailwind CSS)
- **后端**: Node.js + Express.js + TypeScript
- **数据库**: MySQL 8.0+
- **缓存**: Redis
- **文件存储**: MinIO / AWS S3
- **消息队列**: RabbitMQ / Bull
- **认证**: JWT + Refresh Token
- **文档生成**: Puppeteer / PDFKit
- **实时通信**: Socket.io (可选)

### 1.3 设计原则
- **模块化设计**: 高内聚、低耦合的模块划分
- **可扩展性**: 支持水平和垂直扩展
- **安全性**: 多层安全防护机制
- **性能优化**: 缓存、异步处理、数据库优化
- **可维护性**: 清晰的代码结构和文档
- **可测试性**: 单元测试、集成测试覆盖

---

## 2. 系统架构设计

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────┐
│                   客户端层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────┐  │
│  │  Web Browser │  │ Mobile PWA   │  │ API Client│ │
│  │  (React)     │  │  (React)     │  │ (3rd Party)│ │
│  └──────────────┘  └──────────────┘  └──────────┘  │
└────────────────────────┬────────────────────────────┘
                         │ HTTPS
┌────────────────────────▼────────────────────────────┐
│                  接入层 (Nginx)                      │
│  负载均衡 | SSL 终结 | 静态资源服务 | 反向代理       │
└────────────────────────┬────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────┐
│              API 网关层 (Express Gateway)            │
│  认证鉴权 | 流量控制 | API 聚合 | 日志记录           │
└────────────────────────┬────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────┐
│                   应用服务层                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │ Auth Svc │  │ Fund Svc │  │ Investor │          │
│  │          │  │          │  │   Svc    │          │
│  └──────────┘  └──────────┘  └──────────┘          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │Portfolio │  │Accounting│  │ Report   │          │
│  │   Svc    │  │   Svc    │  │   Svc    │          │
│  └──────────┘  └──────────┘  └──────────┘          │
│          (Express.js + TypeScript)                  │
└────────────────────────┬────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────┐
│                   数据层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  MySQL   │  │  Redis   │  │  MinIO   │          │
│  │ (主数据)  │  │  (缓存)   │  │(文件存储)│          │
│  └──────────┘  └──────────┘  └──────────┘          │
│  ┌──────────┐  ┌──────────┐                        │
│  │RabbitMQ  │  │Elastic-  │                        │
│  │(消息队列) │  │ search   │                        │
│  └──────────┘  └──────────┘                        │
└─────────────────────────────────────────────────────┘
```

### 2.2 微服务架构（可选）
考虑到系统复杂度和团队规模，初期可采用单体架构（Monolith），后期按需拆分为微服务。

**服务拆分建议**：
1. **认证服务 (Auth Service)**: 用户认证、授权、权限管理
2. **基金服务 (Fund Service)**: 基金管理、NAV 计算
3. **投资者服务 (Investor Service)**: 投资者管理、资本催缴、分配
4. **投资组合服务 (Portfolio Service)**: 投资管理、估值、交易流
5. **会计服务 (Accounting Service)**: 交易记录、资本账户、总账
6. **绩效服务 (Performance Service)**: 绩效计算、分析
7. **报告服务 (Report Service)**: 报告生成、调度、分发
8. **通知服务 (Notification Service)**: 邮件、短信、系统通知
9. **文档服务 (Document Service)**: 文档管理、存储

---

## 3. 前端技术方案

### 3.1 技术栈详细
```json
{
  "core": {
    "react": "^18.2.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0"
  },
  "routing": {
    "react-router-dom": "^6.20.0"
  },
  "ui": {
    "tailwindcss": "^3.4.0",
    "@headlessui/react": "^1.7.0",
    "@radix-ui/react-*": "^1.0.0",
    "heroicons": "^2.0.0"
  },
  "state": {
    "@tanstack/react-query": "^5.0.0",
    "zustand": "^4.4.0"
  },
  "forms": {
    "react-hook-form": "^7.48.0",
    "zod": "^3.22.0"
  },
  "charts": {
    "recharts": "^2.10.0",
    "apexcharts": "^3.44.0"
  },
  "tables": {
    "@tanstack/react-table": "^8.10.0"
  },
  "date": {
    "date-fns": "^3.0.0"
  },
  "utilities": {
    "axios": "^1.6.0",
    "clsx": "^2.0.0",
    "lodash-es": "^4.17.0"
  }
}
```

### 3.2 项目结构
```
frontend/
├── public/
│   ├── assets/
│   │   ├── images/
│   │   ├── icons/
│   │   └── fonts/
│   └── index.html
├── src/
│   ├── api/                    # API 客户端
│   │   ├── client.ts           # Axios 实例配置
│   │   ├── funds.api.ts
│   │   ├── investors.api.ts
│   │   ├── portfolio.api.ts
│   │   └── ...
│   ├── assets/                 # 静态资源
│   ├── components/             # 通用组件
│   │   ├── common/             # 基础组件
│   │   │   ├── Button/
│   │   │   ├── Input/
│   │   │   ├── Modal/
│   │   │   ├── Table/
│   │   │   └── ...
│   │   ├── charts/             # 图表组件
│   │   │   ├── LineChart/
│   │   │   ├── BarChart/
│   │   │   ├── PieChart/
│   │   │   └── ...
│   │   ├── forms/              # 表单组件
│   │   └── layout/             # 布局组件
│   │       ├── Header/
│   │       ├── Sidebar/
│   │       └── Footer/
│   ├── features/               # 业务功能模块
│   │   ├── auth/               # 认证模块
│   │   │   ├── components/
│   │   │   ├── hooks/
│   │   │   ├── api/
│   │   │   └── types/
│   │   ├── funds/              # 基金模块
│   │   │   ├── components/
│   │   │   │   ├── FundList/
│   │   │   │   ├── FundDetail/
│   │   │   │   └── NAVCalculation/
│   │   │   ├── hooks/
│   │   │   │   ├── useFunds.ts
│   │   │   │   ├── useFundDetail.ts
│   │   │   │   └── useNAV.ts
│   │   │   ├── api/
│   │   │   │   └── funds.api.ts
│   │   │   └── types/
│   │   │       └── fund.types.ts
│   │   ├── investors/          # 投资者模块
│   │   ├── portfolio/          # 投资组合模块
│   │   ├── accounting/         # 会计模块
│   │   ├── performance/        # 绩效模块
│   │   ├── reporting/          # 报告模块
│   │   └── ...
│   ├── hooks/                  # 全局 Hooks
│   │   ├── useAuth.ts
│   │   ├── usePermissions.ts
│   │   ├── useDebounce.ts
│   │   └── ...
│   ├── layouts/                # 页面布局
│   │   ├── MainLayout.tsx
│   │   ├── AuthLayout.tsx
│   │   └── PortalLayout.tsx
│   ├── pages/                  # 页面组件
│   │   ├── Dashboard/
│   │   ├── Funds/
│   │   ├── Investors/
│   │   ├── Portfolio/
│   │   └── ...
│   ├── routes/                 # 路由配置
│   │   ├── index.tsx
│   │   ├── ProtectedRoute.tsx
│   │   └── routes.config.ts
│   ├── store/                  # 全局状态
│   │   ├── authStore.ts
│   │   ├── uiStore.ts
│   │   └── ...
│   ├── types/                  # TypeScript 类型
│   │   ├── api.types.ts
│   │   ├── common.types.ts
│   │   └── ...
│   ├── utils/                  # 工具函数
│   │   ├── format.ts           # 格式化函数
│   │   ├── validation.ts       # 验证函数
│   │   ├── calculation.ts      # 计算函数
│   │   └── constants.ts        # 常量定义
│   ├── App.tsx
│   ├── main.tsx
│   └── vite-env.d.ts
├── .env.development
├── .env.production
├── package.json
├── tsconfig.json
├── tailwind.config.js
└── vite.config.ts
```

### 3.3 状态管理策略

#### 3.3.1 服务端状态 (TanStack Query)
用于管理从 API 获取的数据，自动处理缓存、重新验证、后台更新。

```typescript
// src/features/funds/hooks/useFunds.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { fundsApi } from '../api/funds.api';

export function useFunds() {
  return useQuery({
    queryKey: ['funds'],
    queryFn: fundsApi.getAllFunds,
    staleTime: 5 * 60 * 1000, // 5 分钟
  });
}

export function useCreateFund() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: fundsApi.createFund,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['funds'] });
    },
  });
}
```

#### 3.3.2 客户端状态 (Zustand)
用于管理 UI 状态、用户偏好等本地状态。

```typescript
// src/store/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  user: User | null;
  token: string | null;
  setAuth: (user: User, token: string) => void;
  clearAuth: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      token: null,
      setAuth: (user, token) => set({ user, token }),
      clearAuth: () => set({ user: null, token: null }),
    }),
    {
      name: 'auth-storage',
    }
  )
);
```

### 3.4 API 客户端配置

```typescript
// src/api/client.ts
import axios from 'axios';
import { useAuthStore } from '@/store/authStore';

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器 - 添加 JWT Token
apiClient.interceptors.request.use(
  (config) => {
    const token = useAuthStore.getState().token;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器 - 处理错误和 Token 刷新
apiClient.interceptors.response.use(
  (response) => response.data,
  async (error) => {
    const originalRequest = error.config;

    // Token 过期，尝试刷新
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      try {
        const { data } = await axios.post('/api/auth/refresh-token', {
          refreshToken: localStorage.getItem('refreshToken'),
        });
        useAuthStore.getState().setAuth(data.user, data.token);
        originalRequest.headers.Authorization = `Bearer ${data.token}`;
        return apiClient(originalRequest);
      } catch (refreshError) {
        useAuthStore.getState().clearAuth();
        window.location.href = '/login';
        return Promise.reject(refreshError);
      }
    }

    return Promise.reject(error);
  }
);

export default apiClient;
```

### 3.5 路由配置

```typescript
// src/routes/index.tsx
import { createBrowserRouter } from 'react-router-dom';
import MainLayout from '@/layouts/MainLayout';
import AuthLayout from '@/layouts/AuthLayout';
import ProtectedRoute from './ProtectedRoute';

// Lazy load pages
const Dashboard = lazy(() => import('@/pages/Dashboard'));
const FundList = lazy(() => import('@/pages/Funds/FundList'));
const FundDetail = lazy(() => import('@/pages/Funds/FundDetail'));
// ... more imports

export const router = createBrowserRouter([
  {
    path: '/',
    element: <ProtectedRoute><MainLayout /></ProtectedRoute>,
    children: [
      {
        index: true,
        element: <Dashboard />,
      },
      {
        path: 'funds',
        children: [
          { index: true, element: <FundList /> },
          { path: ':fundId', element: <FundDetail /> },
          { path: ':fundId/nav', element: <NAVCalculation /> },
        ],
      },
      // ... more routes
    ],
  },
  {
    path: '/auth',
    element: <AuthLayout />,
    children: [
      { path: 'login', element: <Login /> },
      { path: 'register', element: <Register /> },
    ],
  },
]);
```

---

## 4. 后端技术方案

### 4.1 技术栈详细
```json
{
  "core": {
    "express": "^4.18.0",
    "typescript": "^5.0.0"
  },
  "database": {
    "mysql2": "^3.6.0",
    "typeorm": "^0.3.17",
    "redis": "^4.6.0"
  },
  "validation": {
    "class-validator": "^0.14.0",
    "class-transformer": "^0.5.1"
  },
  "auth": {
    "jsonwebtoken": "^9.0.0",
    "bcrypt": "^5.1.0",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.0"
  },
  "utils": {
    "date-fns": "^3.0.0",
    "lodash": "^4.17.0",
    "uuid": "^9.0.0"
  },
  "file": {
    "minio": "^7.1.0",
    "multer": "^1.4.0"
  },
  "messaging": {
    "bull": "^4.11.0",
    "nodemailer": "^6.9.0"
  },
  "pdf": {
    "puppeteer": "^21.0.0",
    "pdfkit": "^0.13.0"
  },
  "logging": {
    "winston": "^3.11.0",
    "morgan": "^1.10.0"
  },
  "testing": {
    "jest": "^29.7.0",
    "supertest": "^6.3.0"
  }
}
```

### 4.2 项目结构
```
backend/
├── src/
│   ├── config/                 # 配置文件
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   ├── jwt.config.ts
│   │   └── app.config.ts
│   ├── modules/                # 业务模块
│   │   ├── auth/               # 认证模块
│   │   │   ├── controllers/
│   │   │   │   └── auth.controller.ts
│   │   │   ├── services/
│   │   │   │   └── auth.service.ts
│   │   │   ├── middlewares/
│   │   │   │   ├── auth.middleware.ts
│   │   │   │   └── permissions.middleware.ts
│   │   │   ├── dto/
│   │   │   │   ├── login.dto.ts
│   │   │   │   └── register.dto.ts
│   │   │   ├── entities/
│   │   │   │   ├── user.entity.ts
│   │   │   │   └── role.entity.ts
│   │   │   └── auth.routes.ts
│   │   ├── funds/              # 基金模块
│   │   │   ├── controllers/
│   │   │   │   ├── fund.controller.ts
│   │   │   │   └── nav.controller.ts
│   │   │   ├── services/
│   │   │   │   ├── fund.service.ts
│   │   │   │   └── nav.service.ts
│   │   │   ├── dto/
│   │   │   │   ├── create-fund.dto.ts
│   │   │   │   └── update-fund.dto.ts
│   │   │   ├── entities/
│   │   │   │   ├── fund.entity.ts
│   │   │   │   ├── nav.entity.ts
│   │   │   │   └── fee.entity.ts
│   │   │   └── fund.routes.ts
│   │   ├── investors/          # 投资者模块
│   │   │   ├── controllers/
│   │   │   ├── services/
│   │   │   ├── dto/
│   │   │   ├── entities/
│   │   │   └── investor.routes.ts
│   │   ├── portfolio/          # 投资组合模块
│   │   │   ├── controllers/
│   │   │   ├── services/
│   │   │   ├── dto/
│   │   │   ├── entities/
│   │   │   └── portfolio.routes.ts
│   │   ├── accounting/         # 会计模块
│   │   │   ├── controllers/
│   │   │   ├── services/
│   │   │   ├── dto/
│   │   │   ├── entities/
│   │   │   └── accounting.routes.ts
│   │   ├── performance/        # 绩效模块
│   │   │   ├── controllers/
│   │   │   ├── services/
│   │   │   │   ├── performance.service.ts
│   │   │   │   ├── irr-calculator.service.ts
│   │   │   │   └── tvpi-calculator.service.ts
│   │   │   ├── dto/
│   │   │   ├── entities/
│   │   │   └── performance.routes.ts
│   │   ├── reporting/          # 报告模块
│   │   │   ├── controllers/
│   │   │   ├── services/
│   │   │   │   ├── report.service.ts
│   │   │   │   ├── pdf-generator.service.ts
│   │   │   │   └── report-scheduler.service.ts
│   │   │   ├── dto/
│   │   │   ├── entities/
│   │   │   ├── templates/      # 报告模板
│   │   │   └── reporting.routes.ts
│   │   └── notifications/      # 通知模块
│   │       ├── controllers/
│   │       ├── services/
│   │       │   ├── notification.service.ts
│   │       │   └── email.service.ts
│   │       ├── dto/
│   │       ├── entities/
│   │       └── notification.routes.ts
│   ├── shared/                 # 共享模块
│   │   ├── decorators/         # 自定义装饰器
│   │   │   ├── roles.decorator.ts
│   │   │   └── validate.decorator.ts
│   │   ├── guards/             # 守卫
│   │   │   ├── auth.guard.ts
│   │   │   └── roles.guard.ts
│   │   ├── interceptors/       # 拦截器
│   │   │   ├── logging.interceptor.ts
│   │   │   └── transform.interceptor.ts
│   │   ├── filters/            # 异常过滤器
│   │   │   └── http-exception.filter.ts
│   │   ├── utils/              # 工具函数
│   │   │   ├── calculation.util.ts
│   │   │   ├── date.util.ts
│   │   │   └── encryption.util.ts
│   │   └── types/              # 共享类型
│   │       └── common.types.ts
│   ├── database/               # 数据库相关
│   │   ├── migrations/         # 数据库迁移
│   │   ├── seeds/              # 种子数据
│   │   └── data-source.ts      # TypeORM 数据源
│   ├── jobs/                   # 后台任务
│   │   ├── report-generation.job.ts
│   │   ├── nav-calculation.job.ts
│   │   └── email-sending.job.ts
│   ├── app.ts                  # Express 应用配置
│   ├── server.ts               # 服务器启动文件
│   └── routes.ts               # 路由汇总
├── tests/                      # 测试文件
│   ├── unit/
│   ├── integration/
│   └── e2e/
├── .env.development
├── .env.production
├── package.json
├── tsconfig.json
└── jest.config.js
```

### 4.3 核心代码示例

#### 4.3.1 应用入口
```typescript
// src/app.ts
import express, { Application } from 'express';
import helmet from 'helmet';
import cors from 'cors';
import morgan from 'morgan';
import routes from './routes';
import { errorHandler } from './shared/middlewares/error-handler.middleware';
import { logger } from './shared/utils/logger.util';

export function createApp(): Application {
  const app = express();

  // 安全性中间件
  app.use(helmet());
  app.use(cors({
    origin: process.env.FRONTEND_URL,
    credentials: true,
  }));

  // 请求解析
  app.use(express.json());
  app.use(express.urlencoded({ extended: true }));

  // 日志
  app.use(morgan('combined', { stream: logger.stream }));

  // 路由
  app.use('/api', routes);

  // 错误处理
  app.use(errorHandler);

  return app;
}
```

```typescript
// src/server.ts
import 'reflect-metadata';
import { createApp } from './app';
import { AppDataSource } from './database/data-source';
import { logger } from './shared/utils/logger.util';
import { initializeRedis } from './config/redis.config';
import { initializeQueues } from './jobs';

async function bootstrap() {
  try {
    // 初始化数据库
    await AppDataSource.initialize();
    logger.info('Database connected');

    // 初始化 Redis
    await initializeRedis();
    logger.info('Redis connected');

    // 初始化任务队列
    await initializeQueues();
    logger.info('Job queues initialized');

    // 启动服务器
    const app = createApp();
    const PORT = process.env.PORT || 3000;

    app.listen(PORT, () => {
      logger.info(`Server is running on port ${PORT}`);
    });
  } catch (error) {
    logger.error('Failed to start server:', error);
    process.exit(1);
  }
}

bootstrap();
```

#### 4.3.2 实体定义示例
```typescript
// src/modules/funds/entities/fund.entity.ts
import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  CreateDateColumn,
  UpdateDateColumn,
  OneToMany,
  ManyToOne,
} from 'typeorm';
import { FundType, FundStatus } from '../enums/fund.enum';
import { Investment } from '../../portfolio/entities/investment.entity';
import { Investor } from '../../investors/entities/investor.entity';

@Entity('funds')
export class Fund {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ length: 255 })
  name: string;

  @Column({
    type: 'enum',
    enum: FundType,
  })
  type: FundType;

  @Column({
    type: 'enum',
    enum: FundStatus,
    default: FundStatus.FUNDRAISING,
  })
  status: FundStatus;

  @Column({ type: 'decimal', precision: 20, scale: 2 })
  targetSize: number;

  @Column({ type: 'decimal', precision: 20, scale: 2, default: 0 })
  raisedAmount: number;

  @Column({ type: 'date' })
  inceptionDate: Date;

  @Column({ type: 'date', nullable: true })
  finalCloseDate: Date;

  @Column({ type: 'int', default: 10 })
  fundLife: number; // 存续期（年）

  @Column({ type: 'decimal', precision: 5, scale: 2, default: 2.00 })
  managementFeeRate: number; // 管理费率 (%)

  @Column({ type: 'decimal', precision: 5, scale: 2, default: 20.00 })
  carriedInterestRate: number; // 业绩报酬率 (%)

  @Column({ type: 'decimal', precision: 5, scale: 2, default: 8.00 })
  hurdleRate: number; // 门槛收益率 (%)

  @Column({ type: 'text', nullable: true })
  strategy: string;

  @Column({ type: 'text', nullable: true })
  description: string;

  @Column({ length: 3, default: 'USD' })
  currency: string;

  @OneToMany(() => Investment, (investment) => investment.fund)
  investments: Investment[];

  @OneToMany(() => Investor, (investor) => investor.fund)
  investors: Investor[];

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;

  @Column({ type: 'boolean', default: false })
  isDeleted: boolean;
}
```

#### 4.3.3 服务层示例
```typescript
// src/modules/funds/services/fund.service.ts
import { Repository } from 'typeorm';
import { AppDataSource } from '@/database/data-source';
import { Fund } from '../entities/fund.entity';
import { CreateFundDto } from '../dto/create-fund.dto';
import { UpdateFundDto } from '../dto/update-fund.dto';
import { NotFoundException, BadRequestException } from '@/shared/exceptions';
import { logger } from '@/shared/utils/logger.util';
import { cache } from '@/config/redis.config';

export class FundService {
  private fundRepository: Repository<Fund>;

  constructor() {
    this.fundRepository = AppDataSource.getRepository(Fund);
  }

  async create(createFundDto: CreateFundDto): Promise<Fund> {
    try {
      const fund = this.fundRepository.create(createFundDto);
      const savedFund = await this.fundRepository.save(fund);

      // 清除缓存
      await cache.del('funds:all');

      logger.info(`Fund created: ${savedFund.id}`);
      return savedFund;
    } catch (error) {
      logger.error('Error creating fund:', error);
      throw new BadRequestException('Failed to create fund');
    }
  }

  async findAll(): Promise<Fund[]> {
    // 尝试从缓存获取
    const cached = await cache.get('funds:all');
    if (cached) {
      return JSON.parse(cached);
    }

    const funds = await this.fundRepository.find({
      where: { isDeleted: false },
      order: { createdAt: 'DESC' },
    });

    // 缓存 5 分钟
    await cache.setex('funds:all', 300, JSON.stringify(funds));

    return funds;
  }

  async findOne(id: string): Promise<Fund> {
    const cacheKey = `fund:${id}`;
    const cached = await cache.get(cacheKey);

    if (cached) {
      return JSON.parse(cached);
    }

    const fund = await this.fundRepository.findOne({
      where: { id, isDeleted: false },
      relations: ['investments', 'investors'],
    });

    if (!fund) {
      throw new NotFoundException(`Fund with ID ${id} not found`);
    }

    await cache.setex(cacheKey, 300, JSON.stringify(fund));
    return fund;
  }

  async update(id: string, updateFundDto: UpdateFundDto): Promise<Fund> {
    const fund = await this.findOne(id);

    Object.assign(fund, updateFundDto);
    const updatedFund = await this.fundRepository.save(fund);

    // 清除缓存
    await cache.del(`fund:${id}`);
    await cache.del('funds:all');

    logger.info(`Fund updated: ${id}`);
    return updatedFund;
  }

  async remove(id: string): Promise<void> {
    const fund = await this.findOne(id);

    fund.isDeleted = true;
    await this.fundRepository.save(fund);

    // 清除缓存
    await cache.del(`fund:${id}`);
    await cache.del('funds:all');

    logger.info(`Fund deleted: ${id}`);
  }

  async calculateAUM(fundId: string): Promise<number> {
    const result = await this.fundRepository
      .createQueryBuilder('fund')
      .leftJoin('fund.investments', 'investment')
      .select('SUM(investment.currentValue)', 'totalAUM')
      .where('fund.id = :fundId', { fundId })
      .andWhere('fund.isDeleted = false')
      .getRawOne();

    return parseFloat(result.totalAUM) || 0;
  }
}
```

#### 4.3.4 控制器示例
```typescript
// src/modules/funds/controllers/fund.controller.ts
import { Request, Response, NextFunction } from 'express';
import { FundService } from '../services/fund.service';
import { CreateFundDto } from '../dto/create-fund.dto';
import { validate } from 'class-validator';
import { plainToClass } from 'class-transformer';

export class FundController {
  private fundService: FundService;

  constructor() {
    this.fundService = new FundService();
  }

  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const createFundDto = plainToClass(CreateFundDto, req.body);

      // 验证 DTO
      const errors = await validate(createFundDto);
      if (errors.length > 0) {
        return res.status(400).json({
          success: false,
          errors: errors.map(err => Object.values(err.constraints || {})),
        });
      }

      const fund = await this.fundService.create(createFundDto);

      return res.status(201).json({
        success: true,
        data: fund,
      });
    } catch (error) {
      next(error);
    }
  }

  async findAll(req: Request, res: Response, next: NextFunction) {
    try {
      const funds = await this.fundService.findAll();

      return res.status(200).json({
        success: true,
        data: funds,
      });
    } catch (error) {
      next(error);
    }
  }

  async findOne(req: Request, res: Response, next: NextFunction) {
    try {
      const { id } = req.params;
      const fund = await this.fundService.findOne(id);

      return res.status(200).json({
        success: true,
        data: fund,
      });
    } catch (error) {
      next(error);
    }
  }

  async update(req: Request, res: Response, next: NextFunction) {
    try {
      const { id } = req.params;
      const updateFundDto = plainToClass(UpdateFundDto, req.body);

      const fund = await this.fundService.update(id, updateFundDto);

      return res.status(200).json({
        success: true,
        data: fund,
      });
    } catch (error) {
      next(error);
    }
  }

  async remove(req: Request, res: Response, next: NextFunction) {
    try {
      const { id } = req.params;
      await this.fundService.remove(id);

      return res.status(200).json({
        success: true,
        message: 'Fund deleted successfully',
      });
    } catch (error) {
      next(error);
    }
  }
}
```

#### 4.3.5 路由定义
```typescript
// src/modules/funds/fund.routes.ts
import { Router } from 'express';
import { FundController } from './controllers/fund.controller';
import { authMiddleware } from '@/shared/middlewares/auth.middleware';
import { permissionMiddleware } from '@/shared/middlewares/permission.middleware';

const router = Router();
const fundController = new FundController();

// 所有路由需要认证
router.use(authMiddleware);

router.get('/', fundController.findAll.bind(fundController));
router.get('/:id', fundController.findOne.bind(fundController));

// 创建和更新需要特定权限
router.post(
  '/',
  permissionMiddleware(['fund:create']),
  fundController.create.bind(fundController)
);

router.put(
  '/:id',
  permissionMiddleware(['fund:update']),
  fundController.update.bind(fundController)
);

router.delete(
  '/:id',
  permissionMiddleware(['fund:delete']),
  fundController.remove.bind(fundController)
);

export default router;
```

### 4.4 绩效计算服务

```typescript
// src/modules/performance/services/irr-calculator.service.ts
export class IRRCalculatorService {
  /**
   * 计算内部收益率 (IRR)
   * 使用牛顿迭代法求解 NPV = 0 时的折现率
   * @param cashFlows - 现金流数组 [{date: Date, amount: number}]
   * @returns IRR 百分比
   */
  calculateIRR(cashFlows: CashFlow[]): number {
    if (cashFlows.length < 2) {
      throw new Error('At least 2 cash flows are required');
    }

    // 按日期排序
    const sortedCashFlows = [...cashFlows].sort(
      (a, b) => a.date.getTime() - b.date.getTime()
    );

    const baseDate = sortedCashFlows[0].date;

    // 牛顿迭代法
    let rate = 0.1; // 初始猜测值 10%
    const maxIterations = 1000;
    const tolerance = 1e-6;

    for (let i = 0; i < maxIterations; i++) {
      let npv = 0;
      let npvDerivative = 0;

      for (const cf of sortedCashFlows) {
        const years = this.daysBetween(baseDate, cf.date) / 365;
        const discountFactor = Math.pow(1 + rate, years);

        npv += cf.amount / discountFactor;
        npvDerivative -= (years * cf.amount) / Math.pow(1 + rate, years + 1);
      }

      if (Math.abs(npv) < tolerance) {
        return rate * 100; // 转换为百分比
      }

      rate = rate - npv / npvDerivative;
    }

    throw new Error('IRR calculation did not converge');
  }

  /**
   * 计算两个日期之间的天数
   */
  private daysBetween(date1: Date, date2: Date): number {
    const oneDay = 24 * 60 * 60 * 1000;
    return Math.round(Math.abs((date2.getTime() - date1.getTime()) / oneDay));
  }

  /**
   * 计算 TVPI (Total Value to Paid-In)
   */
  calculateTVPI(
    distributions: number,
    remainingValue: number,
    paidIn: number
  ): number {
    if (paidIn === 0) return 0;
    return (distributions + remainingValue) / paidIn;
  }

  /**
   * 计算 DPI (Distributions to Paid-In)
   */
  calculateDPI(distributions: number, paidIn: number): number {
    if (paidIn === 0) return 0;
    return distributions / paidIn;
  }

  /**
   * 计算 RVPI (Residual Value to Paid-In)
   */
  calculateRVPI(remainingValue: number, paidIn: number): number {
    if (paidIn === 0) return 0;
    return remainingValue / paidIn;
  }
}
```

### 4.5 认证和授权

#### 4.5.1 JWT 认证中间件
```typescript
// src/shared/middlewares/auth.middleware.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import { UnauthorizedException } from '@/shared/exceptions';

export interface AuthRequest extends Request {
  user?: {
    id: string;
    email: string;
    roles: string[];
  };
}

export async function authMiddleware(
  req: AuthRequest,
  res: Response,
  next: NextFunction
) {
  try {
    const authHeader = req.headers.authorization;

    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      throw new UnauthorizedException('No token provided');
    }

    const token = authHeader.substring(7);

    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
      req.user = {
        id: decoded.id,
        email: decoded.email,
        roles: decoded.roles,
      };
      next();
    } catch (error) {
      throw new UnauthorizedException('Invalid or expired token');
    }
  } catch (error) {
    next(error);
  }
}
```

#### 4.5.2 权限检查中间件
```typescript
// src/shared/middlewares/permission.middleware.ts
import { Response, NextFunction } from 'express';
import { AuthRequest } from './auth.middleware';
import { ForbiddenException } from '@/shared/exceptions';

export function permissionMiddleware(requiredPermissions: string[]) {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      if (!req.user) {
        throw new ForbiddenException('User not authenticated');
      }

      // 检查用户权限（简化示例，实际应从数据库获取）
      const userPermissions = await getUserPermissions(req.user.id);

      const hasPermission = requiredPermissions.every((permission) =>
        userPermissions.includes(permission)
      );

      if (!hasPermission) {
        throw new ForbiddenException('Insufficient permissions');
      }

      next();
    } catch (error) {
      next(error);
    }
  };
}

async function getUserPermissions(userId: string): Promise<string[]> {
  // 实际实现应从数据库或缓存获取用户权限
  // 这里简化处理
  return ['fund:read', 'fund:create', 'fund:update'];
}
```

---

## 5. 数据库设计

### 5.1 核心表结构

#### 5.1.1 用户和权限表
```sql
-- 用户表
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  phone VARCHAR(20),
  is_active BOOLEAN DEFAULT TRUE,
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 角色表
CREATE TABLE roles (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(50) UNIQUE NOT NULL,
  description TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 权限表
CREATE TABLE permissions (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  resource VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,
  description TEXT,
  INDEX idx_resource_action (resource, action)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 用户角色关联表
CREATE TABLE user_roles (
  user_id VARCHAR(36),
  role_id VARCHAR(36),
  PRIMARY KEY (user_id, role_id),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 角色权限关联表
CREATE TABLE role_permissions (
  role_id VARCHAR(36),
  permission_id VARCHAR(36),
  PRIMARY KEY (role_id, permission_id),
  FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.2 基金相关表
```sql
-- 基金表
CREATE TABLE funds (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  type ENUM('PE', 'VC', 'RE', 'Infrastructure', 'Credit', 'Fund_of_Funds') NOT NULL,
  status ENUM('Fundraising', 'Active', 'Liquidation', 'Closed') DEFAULT 'Fundraising',
  target_size DECIMAL(20, 2) NOT NULL,
  raised_amount DECIMAL(20, 2) DEFAULT 0,
  inception_date DATE NOT NULL,
  final_close_date DATE,
  fund_life INT DEFAULT 10 COMMENT '存续期（年）',
  management_fee_rate DECIMAL(5, 2) DEFAULT 2.00 COMMENT '管理费率 (%)',
  carried_interest_rate DECIMAL(5, 2) DEFAULT 20.00 COMMENT '业绩报酬率 (%)',
  hurdle_rate DECIMAL(5, 2) DEFAULT 8.00 COMMENT '门槛收益率 (%)',
  strategy TEXT,
  description TEXT,
  currency VARCHAR(3) DEFAULT 'USD',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  is_deleted BOOLEAN DEFAULT FALSE,
  INDEX idx_type (type),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- NAV 表
CREATE TABLE navs (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  valuation_date DATE NOT NULL,
  nav_per_share DECIMAL(20, 6) NOT NULL,
  total_nav DECIMAL(20, 2) NOT NULL,
  total_assets DECIMAL(20, 2) NOT NULL,
  total_liabilities DECIMAL(20, 2) NOT NULL,
  status ENUM('Draft', 'Under_Review', 'Approved', 'Published') DEFAULT 'Draft',
  notes TEXT,
  created_by VARCHAR(36),
  approved_by VARCHAR(36),
  approved_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  UNIQUE KEY unique_fund_valuation (fund_id, valuation_date),
  INDEX idx_valuation_date (valuation_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 费用表
CREATE TABLE fees (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  fee_type ENUM('Management_Fee', 'Performance_Fee', 'Admin_Fee', 'Other') NOT NULL,
  amount DECIMAL(20, 2) NOT NULL,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  calculation_method TEXT,
  is_accrued BOOLEAN DEFAULT FALSE,
  accrual_date DATE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund_period (fund_id, period_start, period_end)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.3 投资者相关表
```sql
-- 投资者表
CREATE TABLE investors (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  type ENUM('Individual', 'Institutional', 'Family_Office', 'Sovereign_Wealth', 'Fund_of_Funds') NOT NULL,
  tax_id VARCHAR(50),
  country VARCHAR(2),
  email VARCHAR(255),
  phone VARCHAR(20),
  address TEXT,
  kyc_status ENUM('Pending', 'In_Progress', 'Approved', 'Rejected') DEFAULT 'Pending',
  kyc_completed_date DATE,
  aml_checked BOOLEAN DEFAULT FALSE,
  aml_check_date DATE,
  is_accredited BOOLEAN DEFAULT FALSE,
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  is_deleted BOOLEAN DEFAULT FALSE,
  INDEX idx_type (type),
  INDEX idx_kyc_status (kyc_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 投资者承诺表（投资者在基金中的承诺）
CREATE TABLE commitments (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  investor_id VARCHAR(36) NOT NULL,
  commitment_amount DECIMAL(20, 2) NOT NULL,
  commitment_date DATE NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  unfunded_amount DECIMAL(20, 2),
  status ENUM('Active', 'Closed', 'Cancelled') DEFAULT 'Active',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  UNIQUE KEY unique_fund_investor (fund_id, investor_id),
  INDEX idx_fund (fund_id),
  INDEX idx_investor (investor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 资本催缴表
CREATE TABLE capital_calls (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  call_number INT NOT NULL,
  call_date DATE NOT NULL,
  due_date DATE NOT NULL,
  total_amount DECIMAL(20, 2) NOT NULL,
  purpose TEXT,
  status ENUM('Draft', 'Sent', 'Partial_Received', 'Completed', 'Overdue') DEFAULT 'Draft',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  sent_at DATETIME,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  UNIQUE KEY unique_fund_call (fund_id, call_number),
  INDEX idx_due_date (due_date),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 资本催缴明细表
CREATE TABLE capital_call_details (
  id VARCHAR(36) PRIMARY KEY,
  capital_call_id VARCHAR(36) NOT NULL,
  investor_id VARCHAR(36) NOT NULL,
  amount_due DECIMAL(20, 2) NOT NULL,
  amount_received DECIMAL(20, 2) DEFAULT 0,
  received_date DATE,
  status ENUM('Pending', 'Paid', 'Partial', 'Overdue') DEFAULT 'Pending',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (capital_call_id) REFERENCES capital_calls(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  INDEX idx_capital_call (capital_call_id),
  INDEX idx_investor (investor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 分配表
CREATE TABLE distributions (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  distribution_number INT NOT NULL,
  distribution_date DATE NOT NULL,
  total_amount DECIMAL(20, 2) NOT NULL,
  distribution_type ENUM('Return_of_Capital', 'Capital_Gain', 'Income', 'Mixed') NOT NULL,
  status ENUM('Draft', 'Approved', 'Paid') DEFAULT 'Draft',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  approved_at DATETIME,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund (fund_id),
  INDEX idx_distribution_date (distribution_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 分配明细表
CREATE TABLE distribution_details (
  id VARCHAR(36) PRIMARY KEY,
  distribution_id VARCHAR(36) NOT NULL,
  investor_id VARCHAR(36) NOT NULL,
  amount DECIMAL(20, 2) NOT NULL,
  tax_withheld DECIMAL(20, 2) DEFAULT 0,
  net_amount DECIMAL(20, 2) NOT NULL,
  payment_date DATE,
  payment_method VARCHAR(50),
  status ENUM('Pending', 'Paid') DEFAULT 'Pending',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (distribution_id) REFERENCES distributions(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  INDEX idx_distribution (distribution_id),
  INDEX idx_investor (investor_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.4 投资组合表
```sql
-- 投资组合公司表
CREATE TABLE portfolio_companies (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  legal_name VARCHAR(255),
  industry VARCHAR(100),
  sub_industry VARCHAR(100),
  country VARCHAR(2),
  website VARCHAR(255),
  description TEXT,
  founded_year INT,
  employees_count INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  is_deleted BOOLEAN DEFAULT FALSE,
  INDEX idx_industry (industry)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 投资表
CREATE TABLE investments (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  portfolio_company_id VARCHAR(36) NOT NULL,
  investment_date DATE NOT NULL,
  investment_type ENUM('Equity', 'Debt', 'Convertible', 'SAFE', 'Other') NOT NULL,
  investment_stage ENUM('Seed', 'Series_A', 'Series_B', 'Series_C', 'Growth', 'Buyout', 'Other'),
  initial_investment DECIMAL(20, 2) NOT NULL,
  total_invested DECIMAL(20, 2) NOT NULL,
  ownership_percentage DECIMAL(5, 2),
  current_value DECIMAL(20, 2),
  status ENUM('Active', 'Exited', 'Written_Off') DEFAULT 'Active',
  exit_date DATE,
  exit_value DECIMAL(20, 2),
  exit_type ENUM('IPO', 'M&A', 'Secondary_Sale', 'Buyback', 'Write_Off'),
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  is_deleted BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  FOREIGN KEY (portfolio_company_id) REFERENCES portfolio_companies(id),
  INDEX idx_fund (fund_id),
  INDEX idx_company (portfolio_company_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 估值表
CREATE TABLE valuations (
  id VARCHAR(36) PRIMARY KEY,
  investment_id VARCHAR(36) NOT NULL,
  valuation_date DATE NOT NULL,
  valuation_method ENUM('Cost', 'Market', 'DCF', 'Comparable', 'Other') NOT NULL,
  fair_value DECIMAL(20, 2) NOT NULL,
  unrealized_gain_loss DECIMAL(20, 2),
  notes TEXT,
  created_by VARCHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (investment_id) REFERENCES investments(id),
  INDEX idx_investment_date (investment_id, valuation_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 交易流（Deal Pipeline）表
CREATE TABLE deal_pipeline (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36),
  company_name VARCHAR(255) NOT NULL,
  industry VARCHAR(100),
  stage ENUM('Initial_Contact', 'Due_Diligence', 'IC_Review', 'Execution', 'Closed', 'Rejected') NOT NULL,
  investment_size_min DECIMAL(20, 2),
  investment_size_max DECIMAL(20, 2),
  priority ENUM('High', 'Medium', 'Low') DEFAULT 'Medium',
  lead_partner VARCHAR(36),
  expected_close_date DATE,
  probability INT COMMENT '成功概率 0-100',
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_stage (stage),
  INDEX idx_fund (fund_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.5 会计相关表
```sql
-- 会计科目表
CREATE TABLE chart_of_accounts (
  id VARCHAR(36) PRIMARY KEY,
  account_code VARCHAR(20) UNIQUE NOT NULL,
  account_name VARCHAR(255) NOT NULL,
  account_type ENUM('Asset', 'Liability', 'Equity', 'Revenue', 'Expense') NOT NULL,
  parent_account_id VARCHAR(36),
  is_active BOOLEAN DEFAULT TRUE,
  description TEXT,
  FOREIGN KEY (parent_account_id) REFERENCES chart_of_accounts(id),
  INDEX idx_account_code (account_code),
  INDEX idx_account_type (account_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 交易记录表
CREATE TABLE transactions (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  transaction_date DATE NOT NULL,
  transaction_type ENUM('Capital_Call', 'Investment', 'Distribution', 'Fee', 'Expense', 'Income', 'Other') NOT NULL,
  amount DECIMAL(20, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  description TEXT,
  reference_id VARCHAR(36) COMMENT '关联的业务ID（如投资ID、资本催缴ID等）',
  status ENUM('Draft', 'Posted', 'Reconciled', 'Void') DEFAULT 'Draft',
  created_by VARCHAR(36),
  approved_by VARCHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  posted_at DATETIME,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund_date (fund_id, transaction_date),
  INDEX idx_type (transaction_type),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 交易分录表（复式记账）
CREATE TABLE transaction_entries (
  id VARCHAR(36) PRIMARY KEY,
  transaction_id VARCHAR(36) NOT NULL,
  account_id VARCHAR(36) NOT NULL,
  debit_amount DECIMAL(20, 2) DEFAULT 0,
  credit_amount DECIMAL(20, 2) DEFAULT 0,
  description TEXT,
  FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE CASCADE,
  FOREIGN KEY (account_id) REFERENCES chart_of_accounts(id),
  INDEX idx_transaction (transaction_id),
  INDEX idx_account (account_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 资本账户表
CREATE TABLE capital_accounts (
  id VARCHAR(36) PRIMARY KEY,
  fund_id VARCHAR(36) NOT NULL,
  investor_id VARCHAR(36) NOT NULL,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  beginning_balance DECIMAL(20, 2) DEFAULT 0,
  capital_calls DECIMAL(20, 2) DEFAULT 0,
  distributions DECIMAL(20, 2) DEFAULT 0,
  allocated_income DECIMAL(20, 2) DEFAULT 0,
  allocated_expenses DECIMAL(20, 2) DEFAULT 0,
  ending_balance DECIMAL(20, 2) DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  UNIQUE KEY unique_period (fund_id, investor_id, period_start, period_end),
  INDEX idx_fund_period (fund_id, period_start)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.6 报告和文档表
```sql
-- 报告模板表
CREATE TABLE report_templates (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  type ENUM('Quarterly', 'Annual', 'Capital_Account', 'Tax', 'Custom') NOT NULL,
  description TEXT,
  template_config JSON COMMENT '模板配置（JSON格式）',
  is_active BOOLEAN DEFAULT TRUE,
  created_by VARCHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 报告生成记录表
CREATE TABLE reports (
  id VARCHAR(36) PRIMARY KEY,
  template_id VARCHAR(36),
  fund_id VARCHAR(36),
  report_name VARCHAR(255) NOT NULL,
  report_type VARCHAR(50),
  period_start DATE,
  period_end DATE,
  status ENUM('Generating', 'Completed', 'Failed', 'Sent') DEFAULT 'Generating',
  file_path VARCHAR(500),
  file_size BIGINT,
  generated_by VARCHAR(36),
  generated_at DATETIME,
  sent_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (template_id) REFERENCES report_templates(id),
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund_period (fund_id, period_start, period_end),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 文档管理表
CREATE TABLE documents (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  document_type ENUM('Contract', 'Report', 'Legal', 'Financial', 'Presentation', 'Other') NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size BIGINT,
  mime_type VARCHAR(100),
  entity_type VARCHAR(50) COMMENT '关联实体类型（Fund, Investor, Investment等）',
  entity_id VARCHAR(36) COMMENT '关联实体ID',
  uploaded_by VARCHAR(36),
  uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  is_deleted BOOLEAN DEFAULT FALSE,
  INDEX idx_entity (entity_type, entity_id),
  INDEX idx_type (document_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 5.2 数据库优化

#### 5.2.1 索引策略
- 为高频查询字段添加索引
- 复合索引用于多条件查询
- 避免过多索引影响写入性能
- 定期分析和优化索引

#### 5.2.2 分区策略
对于大数据量表（如 transactions），按日期分区：

```sql
-- 按月分区示例
ALTER TABLE transactions
PARTITION BY RANGE (YEAR(transaction_date) * 100 + MONTH(transaction_date)) (
  PARTITION p202401 VALUES LESS THAN (202402),
  PARTITION p202402 VALUES LESS THAN (202403),
  -- ...
  PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

#### 5.2.3 查询优化
- 避免 SELECT *
- 使用 EXPLAIN 分析查询
- 适当使用缓存
- 批量操作代替单条操作

---

## 6. API 设计

### 6.1 RESTful API 规范

#### 6.1.1 URL 设计
```
GET    /api/v1/funds              # 获取基金列表
POST   /api/v1/funds              # 创建新基金
GET    /api/v1/funds/:id          # 获取基金详情
PUT    /api/v1/funds/:id          # 更新基金
DELETE /api/v1/funds/:id          # 删除基金

GET    /api/v1/funds/:id/nav      # 获取基金NAV
POST   /api/v1/funds/:id/nav      # 创建NAV记录

GET    /api/v1/investors          # 获取投资者列表
POST   /api/v1/investors          # 创建投资者
GET    /api/v1/investors/:id      # 获取投资者详情

GET    /api/v1/capital-calls      # 获取资本催缴列表
POST   /api/v1/capital-calls      # 创建资本催缴
PATCH  /api/v1/capital-calls/:id/send  # 发送资本催缴

GET    /api/v1/investments        # 获取投资列表
POST   /api/v1/investments        # 创建投资
PUT    /api/v1/investments/:id    # 更新投资

GET    /api/v1/performance/fund/:fundId  # 获取基金绩效
GET    /api/v1/performance/investment/:investmentId  # 获取投资绩效

POST   /api/v1/reports/generate   # 生成报告
GET    /api/v1/reports/:id        # 获取报告
```

#### 6.1.2 请求和响应格式

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "Tech Ventures III",
    "type": "PE",
    ...
  },
  "meta": {
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

**分页响应**：
```json
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

**错误响应**：
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": [
      {
        "field": "targetSize",
        "message": "Target size must be greater than 0"
      }
    ]
  },
  "meta": {
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

### 6.2 API 文档

推荐使用 **Swagger / OpenAPI** 自动生成 API 文档。

```typescript
// src/app.ts
import swaggerUi from 'swagger-ui-express';
import swaggerJsdoc from 'swagger-jsdoc';

const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'eFront API',
      version: '1.0.0',
      description: 'Private Equity Fund Management System API',
    },
    servers: [
      {
        url: 'http://localhost:3000/api/v1',
        description: 'Development server',
      },
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
        },
      },
    },
    security: [{ bearerAuth: [] }],
  },
  apis: ['./src/modules/**/*.routes.ts'],
};

const swaggerSpec = swaggerJsdoc(swaggerOptions);

app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));
```

---

## 7. 安全方案

### 7.1 认证和授权
- **JWT Token**: 访问令牌（15分钟过期）
- **Refresh Token**: 刷新令牌（7天过期）
- **角色权限**: RBAC 权限控制
- **多因素认证**: 支持 TOTP (可选)

### 7.2 数据安全
- **密码加密**: bcrypt (salt rounds = 12)
- **数据传输加密**: HTTPS / TLS 1.3
- **数据库加密**: 敏感字段加密存储
- **文件加密**: 文档加密存储

### 7.3 API 安全
- **速率限制**: 防止暴力攻击
- **CORS 配置**: 限制跨域访问
- **SQL 注入防护**: 使用 ORM 参数化查询
- **XSS 防护**: 输入验证和输出转义
- **CSRF 防护**: CSRF Token

```typescript
// 速率限制示例
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分钟
  max: 100, // 最多 100 个请求
  message: 'Too many requests from this IP',
});

app.use('/api/', limiter);
```

### 7.4 审计日志
- 记录所有敏感操作
- 包含用户、时间、操作类型、IP
- 日志不可篡改
- 定期归档

---

## 8. 部署方案

### 8.1 Docker 容器化

#### 8.1.1 Dockerfile (Backend)
```dockerfile
# backend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM node:20-alpine

WORKDIR /app

COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package.json ./

EXPOSE 3000

CMD ["node", "dist/server.js"]
```

#### 8.1.2 Dockerfile (Frontend)
```dockerfile
# frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 8.1.3 Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - efront-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - efront-network

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - efront-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "3000:3000"
    depends_on:
      - mysql
      - redis
      - minio
    networks:
      - efront-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - efront-network

volumes:
  mysql_data:
  redis_data:
  minio_data:

networks:
  efront-network:
    driver: bridge
```

### 8.2 CI/CD 流程

#### 8.2.1 GitHub Actions 示例
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Run tests
        run: |
          cd backend && npm test
          cd ../frontend && npm test

      - name: Build
        run: |
          cd backend && npm run build
          cd ../frontend && npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to production
        run: |
          # 部署脚本
          ssh user@server 'cd /app && docker-compose pull && docker-compose up -d'
```

### 8.3 生产环境架构

```
┌─────────────────────────────────────────────────────┐
│                 Load Balancer (Nginx)               │
│                  (SSL Termination)                  │
└────────────────────┬────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
┌────────▼────────┐   ┌──────────▼──────────┐
│  Frontend       │   │   Backend           │
│  (Nginx)        │   │   (Node.js)         │
│  Container 1    │   │   Container 1       │
└─────────────────┘   └──────────┬──────────┘
                                 │
         ┌───────────────────────┼───────────────────┐
         │                       │                   │
┌────────▼────────┐   ┌──────────▼──────────┐   ┌───▼───────┐
│  MySQL          │   │   Redis             │   │  MinIO    │
│  (Master-Slave) │   │   (Cluster)         │   │ (Cluster) │
└─────────────────┘   └─────────────────────┘   └───────────┘
```

### 8.4 监控和日志

#### 8.4.1 应用监控
- **PM2**: Node.js 进程管理
- **Prometheus + Grafana**: 性能监控和可视化
- **Sentry**: 错误追踪

#### 8.4.2 日志管理
- **Winston**: 应用日志
- **ELK Stack**: 日志收集和分析 (Elasticsearch, Logstash, Kibana)

---

## 9. 测试策略

### 9.1 单元测试
```typescript
// backend/tests/unit/services/fund.service.test.ts
import { FundService } from '@/modules/funds/services/fund.service';

describe('FundService', () => {
  let fundService: FundService;

  beforeEach(() => {
    fundService = new FundService();
  });

  describe('create', () => {
    it('should create a fund successfully', async () => {
      const createFundDto = {
        name: 'Test Fund',
        type: 'PE',
        targetSize: 500000000,
        inceptionDate: new Date('2024-01-01'),
      };

      const result = await fundService.create(createFundDto);

      expect(result).toHaveProperty('id');
      expect(result.name).toBe('Test Fund');
    });
  });
});
```

### 9.2 集成测试
```typescript
// backend/tests/integration/funds.test.ts
import request from 'supertest';
import { createApp } from '@/app';

describe('Funds API', () => {
  let app;
  let token;

  beforeAll(async () => {
    app = createApp();
    // 登录获取 token
    const response = await request(app)
      .post('/api/auth/login')
      .send({ email: 'test@example.com', password: 'password' });
    token = response.body.data.token;
  });

  it('GET /api/funds should return fund list', async () => {
    const response = await request(app)
      .get('/api/v1/funds')
      .set('Authorization', `Bearer ${token}`)
      .expect(200);

    expect(response.body.success).toBe(true);
    expect(Array.isArray(response.body.data)).toBe(true);
  });
});
```

### 9.3 E2E 测试 (Frontend)
使用 Cypress 或 Playwright 进行端到端测试。

---

## 10. 性能优化

### 10.1 前端优化
- **代码分割**: React.lazy + Suspense
- **图片优化**: WebP 格式、懒加载
- **缓存策略**: Service Worker
- **CDN**: 静态资源 CDN 加速

### 10.2 后端优化
- **数据库连接池**: 复用数据库连接
- **Redis 缓存**: 热点数据缓存
- **异步处理**: 耗时任务队列化
- **数据库优化**: 索引、查询优化

### 10.3 网络优化
- **HTTP/2**: 多路复用
- **Gzip 压缩**: 响应压缩
- **Keep-Alive**: 持久连接

---

## 11. 扩展性考虑

### 11.1 水平扩展
- 无状态服务设计
- 负载均衡
- 数据库读写分离
- 缓存集群

### 11.2 垂直扩展
- 增加服务器资源
- 数据库性能优化

### 11.3 微服务化准备
- 模块化设计
- API 网关
- 服务发现
- 分布式事务处理

---

## 12. 附录

### 12.1 环境变量配置

```bash
# .env.example

# 应用配置
NODE_ENV=production
PORT=3000
FRONTEND_URL=https://app.efront.com

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=efront
DB_USER=efront_user
DB_PASSWORD=strong_password

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT 配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=15m
REFRESH_TOKEN_EXPIRES_IN=7d

# 文件存储配置
MINIO_ENDPOINT=localhost
MINIO_PORT=9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_USE_SSL=false
MINIO_BUCKET=efront-documents

# 邮件配置
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=noreply@efront.com
SMTP_PASSWORD=smtp_password

# 日志配置
LOG_LEVEL=info
LOG_FILE_PATH=logs/app.log
```

### 12.2 开发工具推荐
- **IDE**: VSCode
- **API 测试**: Postman / Insomnia
- **数据库管理**: DBeaver / MySQL Workbench
- **版本控制**: Git + GitHub
- **项目管理**: Jira / Linear

### 12.3 技术债务管理
- 定期代码审查
- 技术债务记录和优先级排序
- 重构计划
- 技术升级路线图

---

**文档版本**: 1.0
**创建日期**: 2025-10-21
**最后更新**: 2025-10-21
**作者**: Claude Code
**状态**: 初稿
