# eFront 私募基金管理系统 - 技术方案

## 1. 方案概述

### 1.1 项目背景
基于eFront私募基金管理系统的功能调研，设计并实现一套现代化的私募基金管理系统，支持基金管理、投资管理、投资者关系、资本运作、绩效分析和报告生成等核心业务。

### 1.2 技术选型

**前端技术栈**：
- 框架：React 19 + TypeScript
- UI框架：TailAdmin (基于Tailwind CSS v4)
- 路由：React Router v6
- 状态管理：Redux Toolkit + RTK Query
- 图表：ApexCharts
- 表单：React Hook Form + Zod
- 日期处理：date-fns + Flatpickr
- 国际化：i18next
- 构建工具：Vite

**后端技术栈**：
- 运行环境：Node.js 20.x LTS
- 框架：Express.js 4.x
- 语言：TypeScript 5.x
- 数据库：MySQL 8.0
- ORM：Prisma
- 认证：JWT + Passport.js
- 验证：Zod
- 文件存储：MinIO / AWS S3
- 任务队列：Bull (基于Redis)
- 日志：Winston
- API文档：Swagger/OpenAPI

**DevOps**：
- 容器化：Docker + Docker Compose
- 代码版本控制：Git
- CI/CD：GitHub Actions
- 监控：PM2 + Prometheus + Grafana
- 日志收集：ELK Stack (可选)

### 1.3 架构原则
- 前后端分离
- RESTful API设计
- 模块化、可扩展
- 安全优先
- 性能优化
- 可测试性

---

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户层                                │
│  (Web浏览器 - PC/平板/移动端)                            │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTPS
┌─────────────────▼───────────────────────────────────────┐
│                  前端应用层                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │  React SPA (TailAdmin)                           │   │
│  │  - 路由管理                                       │   │
│  │  - 状态管理 (Redux)                              │   │
│  │  - UI组件库                                       │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────┬───────────────────────────────────────┘
                  │ RESTful API / WebSocket
┌─────────────────▼───────────────────────────────────────┐
│                  API网关层                               │
│  - 路由分发                                              │
│  - 认证/鉴权                                             │
│  - 限流/熔断                                             │
│  - API日志                                               │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                  应用服务层                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │基金服务  │ │投资服务  │ │投资者服务│ │报告服务  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │资本服务  │ │绩效服务  │ │文档服务  │ │通知服务  │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                  数据持久层                              │
│  ┌────────────┐  ┌──────────┐  ┌──────────┐            │
│  │ MySQL DB   │  │  Redis   │  │  MinIO   │            │
│  │ (主数据)   │  │ (缓存)   │  │(文件存储)│            │
│  └────────────┘  └──────────┘  └──────────┘            │
└─────────────────────────────────────────────────────────┘
```

### 2.2 前端架构

```
src/
├── app/                          # 应用配置
│   ├── store.ts                  # Redux store配置
│   ├── api.ts                    # RTK Query API配置
│   └── routes.tsx                # 路由配置
├── features/                     # 功能模块(按业务领域)
│   ├── auth/                     # 认证模块
│   │   ├── components/           # 组件
│   │   ├── hooks/                # 自定义Hooks
│   │   ├── services/             # API服务
│   │   ├── slice.ts              # Redux slice
│   │   └── types.ts              # TypeScript类型
│   ├── funds/                    # 基金管理
│   ├── investments/              # 投资管理
│   ├── investors/                # 投资者管理
│   ├── capital/                  # 资本运作
│   ├── reports/                  # 报告中心
│   ├── performance/              # 绩效分析
│   └── settings/                 # 系统设置
├── components/                   # 共享组件
│   ├── common/                   # 通用组件
│   ├── charts/                   # 图表组件
│   ├── forms/                    # 表单组件
│   └── layout/                   # 布局组件
├── hooks/                        # 全局Hooks
├── utils/                        # 工具函数
│   ├── api.ts                    # API工具
│   ├── format.ts                 # 格式化工具
│   ├── validation.ts             # 验证工具
│   └── helpers.ts                # 辅助函数
├── types/                        # 全局类型定义
├── constants/                    # 常量
├── i18n/                         # 国际化
├── assets/                       # 静态资源
└── App.tsx                       # 应用入口
```

**设计模式**：
- 模块化：按功能域组织代码（features模式）
- 组件复用：共享组件库
- 自定义Hooks：业务逻辑抽离
- HOC/Render Props：增强组件能力
- 状态管理：Redux Toolkit统一管理

### 2.3 后端架构

```
backend/
├── src/
│   ├── app.ts                    # Express应用入口
│   ├── server.ts                 # 服务器启动
│   ├── config/                   # 配置
│   │   ├── database.ts           # 数据库配置
│   │   ├── auth.ts               # 认证配置
│   │   ├── storage.ts            # 存储配置
│   │   └── index.ts              # 总配置
│   ├── modules/                  # 业务模块
│   │   ├── auth/                 # 认证模块
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── auth.routes.ts
│   │   │   ├── auth.middleware.ts
│   │   │   ├── auth.validator.ts
│   │   │   └── auth.types.ts
│   │   ├── funds/                # 基金模块
│   │   ├── investments/          # 投资模块
│   │   ├── investors/            # 投资者模块
│   │   ├── capital/              # 资本运作模块
│   │   ├── performance/          # 绩效模块
│   │   ├── reports/              # 报告模块
│   │   ├── documents/            # 文档模块
│   │   └── notifications/        # 通知模块
│   ├── shared/                   # 共享模块
│   │   ├── middleware/           # 中间件
│   │   │   ├── auth.middleware.ts
│   │   │   ├── error.middleware.ts
│   │   │   ├── logger.middleware.ts
│   │   │   └── validate.middleware.ts
│   │   ├── guards/               # 守卫
│   │   ├── decorators/           # 装饰器
│   │   └── utils/                # 工具函数
│   ├── database/                 # 数据库
│   │   ├── prisma/               # Prisma schema
│   │   │   ├── schema.prisma
│   │   │   └── migrations/
│   │   └── seeds/                # 种子数据
│   ├── types/                    # TypeScript类型
│   └── constants/                # 常量
├── tests/                        # 测试
│   ├── unit/
│   ├── integration/
│   └── e2e/
├── package.json
├── tsconfig.json
└── .env.example
```

**分层架构**：
- Controller层：处理HTTP请求/响应
- Service层：业务逻辑
- Repository层：数据访问（Prisma封装）
- Middleware层：请求拦截和处理

---

## 3. 数据库设计

### 3.1 数据库选型
使用MySQL 8.0，理由：
- 成熟稳定，广泛应用于金融系统
- 强ACID支持，数据一致性高
- 支持复杂查询和事务
- 丰富的生态和工具

### 3.2 核心表设计

#### 3.2.1 用户与权限

**users - 用户表**
```sql
CREATE TABLE users (
  id CHAR(36) PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  phone VARCHAR(50),
  avatar_url VARCHAR(500),
  role_id CHAR(36),
  status ENUM('active', 'inactive', 'suspended') DEFAULT 'active',
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_email (email),
  INDEX idx_role (role_id),
  INDEX idx_status (status)
);
```

**roles - 角色表**
```sql
CREATE TABLE roles (
  id CHAR(36) PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  permissions JSON,
  is_system BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**permissions - 权限表**
```sql
CREATE TABLE permissions (
  id CHAR(36) PRIMARY KEY,
  resource VARCHAR(100) NOT NULL,
  action VARCHAR(50) NOT NULL,
  description TEXT,
  UNIQUE KEY uk_resource_action (resource, action)
);
```

#### 3.2.2 基金相关

**funds - 基金表**
```sql
CREATE TABLE funds (
  id CHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  fund_type ENUM('PE', 'VC', 'RE', 'Infrastructure', 'Debt') NOT NULL,
  total_size DECIMAL(20, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  vintage_year YEAR NOT NULL,
  inception_date DATE NOT NULL,
  fund_term INT COMMENT '基金期限(年)',
  extension_period INT COMMENT '延长期(年)',
  status ENUM('fundraising', 'investing', 'harvesting', 'liquidated') DEFAULT 'fundraising',
  manager_id CHAR(36),
  custodian_bank VARCHAR(255),
  domicile VARCHAR(100),
  management_fee_rate DECIMAL(5, 4),
  performance_fee_rate DECIMAL(5, 4),
  hurdle_rate DECIMAL(5, 4),
  metadata JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_type (fund_type),
  INDEX idx_status (status),
  INDEX idx_vintage (vintage_year)
);
```

**fund_metrics - 基金指标表**
```sql
CREATE TABLE fund_metrics (
  id CHAR(36) PRIMARY KEY,
  fund_id CHAR(36) NOT NULL,
  as_of_date DATE NOT NULL,
  nav DECIMAL(20, 2),
  irr DECIMAL(8, 4),
  moic DECIMAL(8, 4),
  dpi DECIMAL(8, 4),
  rvpi DECIMAL(8, 4),
  tvpi DECIMAL(8, 4),
  committed_capital DECIMAL(20, 2),
  called_capital DECIMAL(20, 2),
  distributed_capital DECIMAL(20, 2),
  remaining_value DECIMAL(20, 2),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  UNIQUE KEY uk_fund_date (fund_id, as_of_date),
  INDEX idx_date (as_of_date)
);
```

#### 3.2.3 投资相关

**investments - 投资表**
```sql
CREATE TABLE investments (
  id CHAR(36) PRIMARY KEY,
  fund_id CHAR(36) NOT NULL,
  company_name VARCHAR(255) NOT NULL,
  industry VARCHAR(100),
  sector VARCHAR(100),
  region VARCHAR(100),
  country VARCHAR(100),
  investment_date DATE NOT NULL,
  investment_stage ENUM('seed', 'early', 'growth', 'late', 'buyout') NOT NULL,
  investment_type ENUM('equity', 'debt', 'convertible', 'preferred') NOT NULL,
  initial_investment DECIMAL(20, 2) NOT NULL,
  ownership_percentage DECIMAL(5, 4),
  current_valuation DECIMAL(20, 2),
  cost_basis DECIMAL(20, 2),
  exit_date DATE,
  exit_type ENUM('IPO', 'M&A', 'secondary', 'write-off'),
  status ENUM('pipeline', 'due_diligence', 'approved', 'active', 'exited') DEFAULT 'pipeline',
  lead_investor_id CHAR(36),
  description TEXT,
  website VARCHAR(500),
  metadata JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund (fund_id),
  INDEX idx_status (status),
  INDEX idx_industry (industry),
  INDEX idx_date (investment_date)
);
```

**valuations - 估值表**
```sql
CREATE TABLE valuations (
  id CHAR(36) PRIMARY KEY,
  investment_id CHAR(36) NOT NULL,
  valuation_date DATE NOT NULL,
  fair_value DECIMAL(20, 2) NOT NULL,
  valuation_method ENUM('market', 'income', 'cost', 'transaction') NOT NULL,
  multiple DECIMAL(8, 4),
  notes TEXT,
  audited BOOLEAN DEFAULT FALSE,
  created_by CHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (investment_id) REFERENCES investments(id),
  INDEX idx_investment (investment_id),
  INDEX idx_date (valuation_date)
);
```

#### 3.2.4 投资者相关

**investors - 投资者表**
```sql
CREATE TABLE investors (
  id CHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  investor_type ENUM('institutional', 'corporate', 'family_office', 'hnwi', 'fund_of_funds') NOT NULL,
  entity_type ENUM('individual', 'partnership', 'corporation', 'trust'),
  domicile VARCHAR(100),
  country VARCHAR(100),
  tax_id VARCHAR(100),
  email VARCHAR(255),
  phone VARCHAR(50),
  address TEXT,
  kyc_status ENUM('pending', 'in_progress', 'approved', 'rejected') DEFAULT 'pending',
  kyc_date DATE,
  aml_status ENUM('pending', 'in_progress', 'approved', 'rejected') DEFAULT 'pending',
  aml_date DATE,
  accredited BOOLEAN DEFAULT FALSE,
  first_investment_date DATE,
  status ENUM('active', 'inactive') DEFAULT 'active',
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_type (investor_type),
  INDEX idx_status (status),
  INDEX idx_kyc (kyc_status)
);
```

**fund_investors - 基金投资者关系表**
```sql
CREATE TABLE fund_investors (
  id CHAR(36) PRIMARY KEY,
  fund_id CHAR(36) NOT NULL,
  investor_id CHAR(36) NOT NULL,
  commitment_amount DECIMAL(20, 2) NOT NULL,
  commitment_date DATE NOT NULL,
  called_amount DECIMAL(20, 2) DEFAULT 0,
  distributed_amount DECIMAL(20, 2) DEFAULT 0,
  current_nav DECIMAL(20, 2) DEFAULT 0,
  ownership_percentage DECIMAL(5, 4),
  investor_class VARCHAR(50),
  side_letter BOOLEAN DEFAULT FALSE,
  status ENUM('committed', 'active', 'withdrawn') DEFAULT 'committed',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  UNIQUE KEY uk_fund_investor (fund_id, investor_id)
);
```

#### 3.2.5 资本运作

**capital_calls - 资本催缴表**
```sql
CREATE TABLE capital_calls (
  id CHAR(36) PRIMARY KEY,
  fund_id CHAR(36) NOT NULL,
  call_number INT NOT NULL,
  call_date DATE NOT NULL,
  due_date DATE NOT NULL,
  purpose TEXT,
  total_amount DECIMAL(20, 2) NOT NULL,
  received_amount DECIMAL(20, 2) DEFAULT 0,
  status ENUM('draft', 'sent', 'partial', 'complete', 'overdue') DEFAULT 'draft',
  bank_account VARCHAR(255),
  notes TEXT,
  created_by CHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund (fund_id),
  INDEX idx_status (status),
  INDEX idx_date (call_date)
);
```

**capital_call_details - 资本催缴明细表**
```sql
CREATE TABLE capital_call_details (
  id CHAR(36) PRIMARY KEY,
  capital_call_id CHAR(36) NOT NULL,
  investor_id CHAR(36) NOT NULL,
  called_amount DECIMAL(20, 2) NOT NULL,
  received_amount DECIMAL(20, 2) DEFAULT 0,
  received_date DATE,
  status ENUM('pending', 'partial', 'paid', 'overdue') DEFAULT 'pending',
  payment_reference VARCHAR(255),
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (capital_call_id) REFERENCES capital_calls(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  INDEX idx_call (capital_call_id),
  INDEX idx_investor (investor_id),
  INDEX idx_status (status)
);
```

**distributions - 分配表**
```sql
CREATE TABLE distributions (
  id CHAR(36) PRIMARY KEY,
  fund_id CHAR(36) NOT NULL,
  distribution_number INT NOT NULL,
  distribution_date DATE NOT NULL,
  payment_date DATE NOT NULL,
  distribution_type ENUM('income', 'capital_gain', 'return_of_capital') NOT NULL,
  total_amount DECIMAL(20, 2) NOT NULL,
  paid_amount DECIMAL(20, 2) DEFAULT 0,
  status ENUM('draft', 'approved', 'processing', 'complete') DEFAULT 'draft',
  notes TEXT,
  created_by CHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund (fund_id),
  INDEX idx_status (status),
  INDEX idx_date (distribution_date)
);
```

**distribution_details - 分配明细表**
```sql
CREATE TABLE distribution_details (
  id CHAR(36) PRIMARY KEY,
  distribution_id CHAR(36) NOT NULL,
  investor_id CHAR(36) NOT NULL,
  distribution_amount DECIMAL(20, 2) NOT NULL,
  paid_amount DECIMAL(20, 2) DEFAULT 0,
  payment_date DATE,
  status ENUM('pending', 'paid') DEFAULT 'pending',
  payment_reference VARCHAR(255),
  withholding_tax DECIMAL(20, 2) DEFAULT 0,
  net_amount DECIMAL(20, 2),
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (distribution_id) REFERENCES distributions(id),
  FOREIGN KEY (investor_id) REFERENCES investors(id),
  INDEX idx_distribution (distribution_id),
  INDEX idx_investor (investor_id)
);
```

#### 3.2.6 交易记录

**transactions - 交易表**
```sql
CREATE TABLE transactions (
  id CHAR(36) PRIMARY KEY,
  fund_id CHAR(36) NOT NULL,
  transaction_date DATE NOT NULL,
  transaction_type ENUM('capital_call', 'distribution', 'investment', 'exit', 'fee', 'expense', 'income', 'other') NOT NULL,
  amount DECIMAL(20, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  description TEXT,
  reference_id CHAR(36) COMMENT '关联ID(催缴/分配/投资等)',
  reference_type VARCHAR(50),
  settlement_date DATE,
  status ENUM('pending', 'settled', 'cancelled') DEFAULT 'pending',
  created_by CHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund (fund_id),
  INDEX idx_type (transaction_type),
  INDEX idx_date (transaction_date),
  INDEX idx_reference (reference_type, reference_id)
);
```

#### 3.2.7 报告与文档

**reports - 报告表**
```sql
CREATE TABLE reports (
  id CHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  report_type ENUM('quarterly', 'annual', 'investor', 'compliance', 'custom') NOT NULL,
  fund_id CHAR(36),
  period_start DATE,
  period_end DATE,
  template_id CHAR(36),
  status ENUM('draft', 'generating', 'ready', 'sent', 'archived') DEFAULT 'draft',
  file_url VARCHAR(500),
  file_size BIGINT,
  generated_at DATETIME,
  sent_at DATETIME,
  recipients JSON,
  metadata JSON,
  created_by CHAR(36),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (fund_id) REFERENCES funds(id),
  INDEX idx_fund (fund_id),
  INDEX idx_type (report_type),
  INDEX idx_status (status)
);
```

**documents - 文档表**
```sql
CREATE TABLE documents (
  id CHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  document_type VARCHAR(100),
  category VARCHAR(100),
  file_url VARCHAR(500) NOT NULL,
  file_size BIGINT,
  mime_type VARCHAR(100),
  version INT DEFAULT 1,
  parent_id CHAR(36) COMMENT '文件夹ID',
  related_entity_type VARCHAR(50) COMMENT '关联实体类型',
  related_entity_id CHAR(36) COMMENT '关联实体ID',
  tags JSON,
  is_public BOOLEAN DEFAULT FALSE,
  uploaded_by CHAR(36),
  uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at DATETIME,
  INDEX idx_type (document_type),
  INDEX idx_category (category),
  INDEX idx_related (related_entity_type, related_entity_id),
  INDEX idx_parent (parent_id)
);
```

#### 3.2.8 通知与日志

**notifications - 通知表**
```sql
CREATE TABLE notifications (
  id CHAR(36) PRIMARY KEY,
  user_id CHAR(36) NOT NULL,
  type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  message TEXT,
  link VARCHAR(500),
  is_read BOOLEAN DEFAULT FALSE,
  read_at DATETIME,
  priority ENUM('low', 'medium', 'high') DEFAULT 'medium',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user (user_id),
  INDEX idx_read (is_read),
  INDEX idx_created (created_at)
);
```

**audit_logs - 审计日志表**
```sql
CREATE TABLE audit_logs (
  id CHAR(36) PRIMARY KEY,
  user_id CHAR(36),
  action VARCHAR(100) NOT NULL,
  entity_type VARCHAR(50) NOT NULL,
  entity_id CHAR(36),
  old_values JSON,
  new_values JSON,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user (user_id),
  INDEX idx_entity (entity_type, entity_id),
  INDEX idx_action (action),
  INDEX idx_created (created_at)
);
```

### 3.3 Prisma Schema示例

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String?   @map("first_name")
  lastName     String?   @map("last_name")
  phone        String?
  avatarUrl    String?   @map("avatar_url")
  roleId       String?   @map("role_id")
  status       UserStatus @default(active)
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  role         Role?     @relation(fields: [roleId], references: [id])

  @@index([email])
  @@index([roleId])
  @@index([status])
  @@map("users")
}

enum UserStatus {
  active
  inactive
  suspended
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  permissions Json?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]

  @@map("roles")
}

model Fund {
  id                  String      @id @default(uuid())
  name                String
  fundType            FundType    @map("fund_type")
  totalSize           Decimal     @db.Decimal(20, 2) @map("total_size")
  currency            String      @default("USD")
  vintageYear         Int         @map("vintage_year")
  inceptionDate       DateTime    @map("inception_date") @db.Date
  fundTerm            Int?        @map("fund_term")
  extensionPeriod     Int?        @map("extension_period")
  status              FundStatus  @default(fundraising)
  managerId           String?     @map("manager_id")
  custodianBank       String?     @map("custodian_bank")
  domicile            String?
  managementFeeRate   Decimal?    @db.Decimal(5, 4) @map("management_fee_rate")
  performanceFeeRate  Decimal?    @db.Decimal(5, 4) @map("performance_fee_rate")
  hurdleRate          Decimal?    @db.Decimal(5, 4) @map("hurdle_rate")
  metadata            Json?
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  deletedAt           DateTime?   @map("deleted_at")

  investments         Investment[]
  fundInvestors       FundInvestor[]
  capitalCalls        CapitalCall[]
  distributions       Distribution[]
  transactions        Transaction[]
  reports             Report[]
  metrics             FundMetric[]

  @@index([fundType])
  @@index([status])
  @@index([vintageYear])
  @@map("funds")
}

enum FundType {
  PE
  VC
  RE
  Infrastructure
  Debt
}

enum FundStatus {
  fundraising
  investing
  harvesting
  liquidated
}

// 其他模型类似定义...
```

---

## 4. API设计

### 4.1 API规范

**RESTful设计原则**：
- 使用名词表示资源
- 使用HTTP方法表示动作（GET/POST/PUT/PATCH/DELETE）
- 使用HTTP状态码
- 统一响应格式
- 版本控制（URL路径：/api/v1）

**统一响应格式**：
```typescript
// 成功响应
{
  "success": true,
  "data": any,
  "message": "操作成功",
  "timestamp": "2025-10-22T10:00:00Z"
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "验证失败",
    "details": [...]
  },
  "timestamp": "2025-10-22T10:00:00Z"
}

// 分页响应
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "total": 100,
    "totalPages": 5
  },
  "timestamp": "2025-10-22T10:00:00Z"
}
```

### 4.2 核心API端点

#### 4.2.1 认证API

```
POST   /api/v1/auth/register          # 注册
POST   /api/v1/auth/login             # 登录
POST   /api/v1/auth/logout            # 登出
POST   /api/v1/auth/refresh           # 刷新Token
POST   /api/v1/auth/forgot-password   # 忘记密码
POST   /api/v1/auth/reset-password    # 重置密码
GET    /api/v1/auth/me                # 获取当前用户信息
PUT    /api/v1/auth/me                # 更新当前用户信息
POST   /api/v1/auth/2fa/enable        # 启用2FA
POST   /api/v1/auth/2fa/verify        # 验证2FA
```

#### 4.2.2 基金API

```
GET    /api/v1/funds                  # 获取基金列表
POST   /api/v1/funds                  # 创建基金
GET    /api/v1/funds/:id              # 获取基金详情
PUT    /api/v1/funds/:id              # 更新基金
PATCH  /api/v1/funds/:id              # 部分更新基金
DELETE /api/v1/funds/:id              # 删除基金（软删除）
GET    /api/v1/funds/:id/metrics      # 获取基金指标
POST   /api/v1/funds/:id/metrics      # 添加基金指标
GET    /api/v1/funds/:id/investors    # 获取基金投资者列表
GET    /api/v1/funds/:id/investments  # 获取基金投资列表
GET    /api/v1/funds/:id/performance  # 获取基金绩效
GET    /api/v1/funds/:id/cashflow     # 获取现金流
```

#### 4.2.3 投资API

```
GET    /api/v1/investments                  # 获取投资列表
POST   /api/v1/investments                  # 创建投资
GET    /api/v1/investments/:id              # 获取投资详情
PUT    /api/v1/investments/:id              # 更新投资
DELETE /api/v1/investments/:id              # 删除投资
GET    /api/v1/investments/:id/valuations   # 获取估值历史
POST   /api/v1/investments/:id/valuations   # 添加估值
GET    /api/v1/investments/:id/financials   # 获取财务数据
POST   /api/v1/investments/:id/financials   # 添加财务数据
GET    /api/v1/investments/:id/documents    # 获取相关文档
```

#### 4.2.4 投资者API

```
GET    /api/v1/investors               # 获取投资者列表
POST   /api/v1/investors               # 创建投资者
GET    /api/v1/investors/:id           # 获取投资者详情
PUT    /api/v1/investors/:id           # 更新投资者
DELETE /api/v1/investors/:id           # 删除投资者
GET    /api/v1/investors/:id/funds     # 获取投资者基金列表
GET    /api/v1/investors/:id/account   # 获取资本账户
POST   /api/v1/investors/:id/kyc       # 提交KYC
PUT    /api/v1/investors/:id/kyc       # 更新KYC状态
```

#### 4.2.5 资本运作API

```
# 资本催缴
GET    /api/v1/capital-calls               # 获取催缴列表
POST   /api/v1/capital-calls               # 创建催缴
GET    /api/v1/capital-calls/:id           # 获取催缴详情
PUT    /api/v1/capital-calls/:id           # 更新催缴
DELETE /api/v1/capital-calls/:id           # 删除催缴
POST   /api/v1/capital-calls/:id/send      # 发送催缴通知
POST   /api/v1/capital-calls/:id/record-payment  # 记录付款
GET    /api/v1/capital-calls/:id/status    # 获取催缴状态

# 分配
GET    /api/v1/distributions               # 获取分配列表
POST   /api/v1/distributions               # 创建分配
GET    /api/v1/distributions/:id           # 获取分配详情
PUT    /api/v1/distributions/:id           # 更新分配
DELETE /api/v1/distributions/:id           # 删除分配
POST   /api/v1/distributions/:id/approve   # 审批分配
POST   /api/v1/distributions/:id/process   # 处理分配
POST   /api/v1/distributions/:id/record-payment  # 记录付款
```

#### 4.2.6 报告API

```
GET    /api/v1/reports                     # 获取报告列表
POST   /api/v1/reports                     # 创建报告
GET    /api/v1/reports/:id                 # 获取报告详情
DELETE /api/v1/reports/:id                 # 删除报告
POST   /api/v1/reports/:id/generate        # 生成报告
POST   /api/v1/reports/:id/send            # 发送报告
GET    /api/v1/reports/:id/download        # 下载报告
GET    /api/v1/reports/templates           # 获取报告模板
```

#### 4.2.7 文档API

```
GET    /api/v1/documents                   # 获取文档列表
POST   /api/v1/documents/upload            # 上传文档
GET    /api/v1/documents/:id               # 获取文档详情
PUT    /api/v1/documents/:id               # 更新文档
DELETE /api/v1/documents/:id               # 删除文档
GET    /api/v1/documents/:id/download      # 下载文档
POST   /api/v1/documents/:id/share         # 分享文档
GET    /api/v1/documents/folders           # 获取文件夹
POST   /api/v1/documents/folders           # 创建文件夹
```

#### 4.2.8 数据API

```
POST   /api/v1/data/import                 # 数据导入
GET    /api/v1/data/import/:id/status      # 获取导入状态
POST   /api/v1/data/export                 # 数据导出
GET    /api/v1/data/export/:id/download    # 下载导出文件
GET    /api/v1/data/templates              # 获取导入模板
```

### 4.3 请求示例

**获取基金列表**：
```http
GET /api/v1/funds?page=1&pageSize=20&status=active&fundType=PE&sort=-vintageYear
Authorization: Bearer <token>
```

**创建资本催缴**：
```http
POST /api/v1/capital-calls
Authorization: Bearer <token>
Content-Type: application/json

{
  "fundId": "uuid",
  "callDate": "2025-11-15",
  "dueDate": "2025-12-01",
  "purpose": "投资项目ABC",
  "investors": [
    {
      "investorId": "uuid",
      "amount": 5000000
    },
    ...
  ],
  "bankAccount": "账户信息",
  "sendNotification": true
}
```

---

## 5. 安全设计

### 5.1 认证与授权

**JWT认证**：
- Access Token：有效期15分钟
- Refresh Token：有效期7天
- Token存储：HttpOnly Cookie（防XSS）

**双因素认证（2FA）**：
- 基于TOTP算法
- 可选启用
- 备用验证码

**RBAC权限模型**：
```
用户 → 角色 → 权限
- 角色：管理员、基金经理、分析师、投资者等
- 权限：资源+动作（如：funds:read, investments:write）
- 细粒度控制：字段级、数据行级
```

### 5.2 数据安全

**敏感数据加密**：
- 密码：bcrypt（salt rounds=12）
- 敏感字段：AES-256加密
- 传输：HTTPS/TLS 1.3

**SQL注入防护**：
- 使用Prisma参数化查询
- 输入验证和清洗

**XSS防护**：
- CSP（Content Security Policy）
- 输出转义
- HttpOnly Cookie

**CSRF防护**：
- CSRF Token
- SameSite Cookie

### 5.3 API安全

**限流**：
- IP限流：100请求/分钟
- 用户限流：1000请求/小时
- 使用Redis + rate-limiter-flexible

**请求验证**：
- 使用Zod schema验证
- 文件上传大小限制
- MIME类型检查

**CORS配置**：
```typescript
{
  origin: process.env.FRONTEND_URL,
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
}
```

### 5.4 审计与监控

**审计日志**：
- 记录所有关键操作
- 包含用户、时间、IP、操作内容
- 数据变更前后对比

**安全监控**：
- 异常登录检测
- 批量操作监控
- 敏感操作告警

---

## 6. 性能优化

### 6.1 数据库优化

**索引策略**：
- 主键索引：所有ID字段
- 外键索引：关联字段
- 复合索引：多条件查询
- 全文索引：搜索功能

**查询优化**：
- 避免N+1查询（使用Prisma include）
- 分页查询
- 只查询需要的字段
- 慢查询日志分析

**连接池**：
```typescript
{
  min: 5,
  max: 20,
  idle: 10000,
  acquire: 30000
}
```

### 6.2 缓存策略

**Redis缓存**：
- 用户会话
- 频繁查询数据（基金列表、投资者列表）
- 计算结果（绩效指标）
- 限流计数

**缓存策略**：
- Cache-Aside模式
- TTL设置：5分钟 - 1小时
- 缓存失效：数据更新时主动清除

### 6.3 前端优化

**代码分割**：
- 路由级别懒加载
- 组件按需加载

**资源优化**：
- 图片懒加载
- CDN加速
- Gzip/Brotli压缩

**虚拟滚动**：
- 长列表使用react-window
- 减少DOM节点

**请求优化**：
- 请求合并
- 防抖/节流
- 取消重复请求

---

## 7. 部署方案

### 7.1 Docker容器化

**Dockerfile示例**：
```dockerfile
# 前端
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80

# 后端
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --production
COPY . .
RUN npx prisma generate
EXPOSE 3000
CMD ["npm", "start"]
```

**docker-compose.yml**：
```yaml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    environment:
      - API_URL=http://backend:3000
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=mysql://user:pass@mysql:3306/efront
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - mysql
      - redis
    volumes:
      - ./uploads:/app/uploads

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=efront
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

volumes:
  mysql_data:
  redis_data:
  minio_data:
```

### 7.2 CI/CD流程

**GitHub Actions示例**：
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm test
      - run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to production
        run: |
          # 部署脚本
```

### 7.3 生产环境架构

```
Internet
    │
    ▼
[Load Balancer / Nginx]
    │
    ├──────────────┬──────────────┐
    ▼              ▼              ▼
[Frontend 1]  [Frontend 2]  [Frontend N]
    │
    ▼
[API Gateway]
    │
    ├──────────────┬──────────────┐
    ▼              ▼              ▼
[Backend 1]   [Backend 2]   [Backend N]
    │              │              │
    └──────┬───────┴──────┬───────┘
           │              │
    ┌──────▼──────┐  ┌───▼────┐
    │   MySQL     │  │ Redis  │
    │  (Master)   │  │ Cluster│
    │     │       │  └────────┘
    │  Replica    │
    └─────────────┘
```

---

## 8. 监控与运维

### 8.1 应用监控

**PM2进程管理**：
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'efront-backend',
    script: './dist/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss'
  }]
}
```

**日志系统**：
- Winston日志框架
- 日志级别：error, warn, info, debug
- 日志轮转
- 集中日志收集（可选ELK）

**性能监控**：
- Prometheus指标收集
- Grafana可视化
- 监控指标：
  - 响应时间
  - 请求量
  - 错误率
  - CPU/内存使用率
  - 数据库连接数

### 8.2 告警机制

**告警规则**：
- API响应时间 > 3秒
- 错误率 > 5%
- CPU使用率 > 80%
- 磁盘空间 < 20%

**告警通道**：
- 邮件
- Slack/企业微信
- 短信（紧急）

### 8.3 备份策略

**数据库备份**：
- 全量备份：每日凌晨
- 增量备份：每6小时
- 保留周期：30天
- 异地备份

**文件备份**：
- 定期备份至对象存储
- 版本控制

---

## 9. 测试策略

### 9.1 测试金字塔

```
      /\
     /  \  E2E测试 (少量)
    /────\
   /      \  集成测试 (适量)
  /────────\
 /          \ 单元测试 (大量)
/────────────\
```

### 9.2 测试类型

**单元测试**：
- 框架：Jest
- 覆盖率目标：80%
- 测试范围：工具函数、Service层、纯组件

**集成测试**：
- 框架：Jest + Supertest
- 测试范围：API端点、数据库交互

**E2E测试**：
- 框架：Playwright
- 测试范围：关键业务流程

**性能测试**：
- 工具：k6
- 测试场景：并发用户、大数据量

### 9.3 测试示例

```typescript
// 单元测试
describe('FundService', () => {
  it('should calculate IRR correctly', () => {
    const result = fundService.calculateIRR(cashflows);
    expect(result).toBeCloseTo(0.185, 3);
  });
});

// 集成测试
describe('POST /api/v1/funds', () => {
  it('should create a new fund', async () => {
    const response = await request(app)
      .post('/api/v1/funds')
      .set('Authorization', `Bearer ${token}`)
      .send(fundData);

    expect(response.status).toBe(201);
    expect(response.body.data).toHaveProperty('id');
  });
});

// E2E测试
test('user can create capital call', async ({ page }) => {
  await page.goto('/capital-calls/new');
  await page.fill('[name="fundId"]', 'uuid');
  await page.fill('[name="amount"]', '1000000');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL(/\/capital-calls\/\w+/);
});
```

---

## 10. 开发规范

### 10.1 代码规范

**TypeScript**：
- 严格模式：strict: true
- 禁用any类型（除特殊情况）
- 使用接口定义数据结构

**命名规范**：
- 变量/函数：camelCase
- 类/接口：PascalCase
- 常量：UPPER_SNAKE_CASE
- 文件名：kebab-case

**Linting**：
- ESLint + Prettier
- Git pre-commit hook检查

### 10.2 Git工作流

**分支策略**：
- main：生产环境
- develop：开发环境
- feature/*：功能分支
- bugfix/*：Bug修复
- hotfix/*：紧急修复

**提交规范**：
```
feat: 新功能
fix: Bug修复
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建/工具

示例：
feat(funds): add fund creation API
fix(auth): resolve JWT expiration issue
```

### 10.3 文档规范

**代码注释**：
- JSDoc注释公共API
- 复杂逻辑添加解释性注释
- TODO/FIXME标记

**API文档**：
- Swagger/OpenAPI自动生成
- 包含请求/响应示例
- 错误码说明

**开发文档**：
- README.md：项目说明、快速开始
- CONTRIBUTING.md：贡献指南
- CHANGELOG.md：更新日志

---

## 11. 技术风险与对策

### 11.1 性能风险

**风险**：大数据量查询性能下降
**对策**：
- 数据库索引优化
- 分页查询
- Redis缓存
- 读写分离

### 11.2 安全风险

**风险**：数据泄露、未授权访问
**对策**：
- 完善的认证授权机制
- 数据加密
- 定期安全审计
- 漏洞扫描

### 11.3 可用性风险

**风险**：系统宕机、数据丢失
**对策**：
- 负载均衡
- 数据备份
- 容灾方案
- 健康检查

### 11.4 扩展性风险

**风险**：业务增长导致系统无法扩展
**对策**：
- 微服务架构（未来）
- 水平扩展
- 消息队列解耦
- 数据库分片（如需要）

---

## 12. 实施计划

### 12.1 第一阶段（MVP - 4周）

**核心功能**：
- 用户认证与权限
- 基金管理（CRUD）
- 投资管理（CRUD）
- 投资者管理（CRUD）
- 基础仪表板

**交付物**：
- 可运行的系统
- 基本UI界面
- API文档

### 12.2 第二阶段（功能完善 - 6周）

**增强功能**：
- 资本催缴与分配
- 绩效计算与分析
- 报告生成（基础模板）
- 文档管理
- 数据导入导出

**交付物**：
- 完整业务流程
- 优化的UI/UX
- 测试报告

### 12.3 第三阶段（优化与上线 - 2周）

**工作内容**：
- 性能优化
- 安全加固
- 用户培训
- 生产环境部署
- 监控配置

**交付物**：
- 生产就绪系统
- 运维文档
- 培训材料

---

## 13. 成本估算

### 13.1 开发成本

- 前端开发：2人 × 3个月
- 后端开发：2人 × 3个月
- UI/UX设计：1人 × 1个月
- 测试：1人 × 1个月
- 项目管理：1人 × 3个月

### 13.2 基础设施成本（月）

- 云服务器：$200-500
- 数据库：$100-300
- 对象存储：$50-100
- CDN：$50-150
- 监控/日志：$50-100

**总计**：约$450-1150/月

### 13.3 第三方服务

- 域名/SSL证书：$50/年
- 短信服务：按量计费
- 邮件服务：$20-100/月

---

## 14. 附录

### 14.1 技术选型对比

| 技术领域 | 选择方案 | 备选方案 | 选择理由 |
|---------|---------|---------|---------|
| 前端框架 | React | Vue, Angular | 生态丰富，团队熟悉 |
| 后端框架 | Express | NestJS, Fastify | 简单灵活，易上手 |
| ORM | Prisma | TypeORM, Sequelize | 类型安全，开发体验好 |
| 状态管理 | Redux Toolkit | Zustand, Jotai | 成熟稳定，中大型项目首选 |
| UI框架 | TailAdmin | Ant Design, MUI | 符合需求，定制性强 |

### 14.2 参考资料

- React官方文档：https://react.dev
- Express官方文档：https://expressjs.com
- Prisma文档：https://www.prisma.io/docs
- TailAdmin文档：https://tailadmin.com/docs
- eFront调研报告：见doc/eFront功能调研报告.md

### 14.3 术语表

- **IRR**：Internal Rate of Return，内部收益率
- **MOIC**：Multiple on Invested Capital，投资回报倍数
- **DPI**：Distributions to Paid-In，已分配与已缴资本比率
- **RVPI**：Residual Value to Paid-In，剩余价值与已缴资本比率
- **TVPI**：Total Value to Paid-In，总价值与已缴资本比率
- **NAV**：Net Asset Value，净资产值
- **KYC**：Know Your Customer，了解你的客户
- **AML**：Anti-Money Laundering，反洗钱
- **LP**：Limited Partner，有限合伙人
- **GP**：General Partner，普通合伙人

---

## 15. 更新记录

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-10-22 | 初始版本 | Claude |

---

**文档状态**: 待评审
**下一步**: 开发环境搭建与MVP开发
